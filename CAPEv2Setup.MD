# CAPE Setup
***Payloads or it didn't happen***

<pre>
  .-----------------.
  | CAPE Sandbox? |
  |     OH NOES!    |\  '-.__.-'
  '-----------------' \  /oo |--.--,--,--.
                         \_.-'._i__i__i_.'
                               """""""""
</pre>                               

## CAPE

CAPE is a malware sandbox. It was derived from Cuckoo with the goal of adding automated malware unpacking and config extraction - hence its name is an acronym: 'Config And Payload Extraction'. Automated unpacking allows classification based on Yara signatures to complement network (Suricata) and behavior (API) signatures.

## Requirements | Suggested

- OS Host: **[Ubuntu 20.04 LTS](https://ubuntu.com/#download)**
- OS Guest: **Windows 7**
- Python version on host: **[Python 3.6.8](https://www.python.org/downloads/release/python-368/)**
- Python version on guest: 3.7.2 / 3.8 **x86**
- [KVM](https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine)


## KVM Installation

Installing libvirt
```
sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virtinst virt-manager
```
Adding user
```
sudo adduser YOUR_USERNAME libvirt
sudo adduser YOUR_USERNAME kvm
```

Verify Status
```
sudo systemctl status libvirtd
```

Creating Virtual Machine with virt-manager
```
sudo apt install virt-manager
```

![image](https://user-images.githubusercontent.com/52568048/117666897-9e171d80-b1a4-11eb-8ffd-5b1da6ac65b2.png)

This obviously depends if you want to create a new machine or import one already existing, in case of an existing machine from VirtualBox (**.ova**) you can convert it, but it is strongly not reccomendend to do so [Importing a VirtualBox machine will import also useless artifacts from VirtualBox needs, so it will zero out the advantage of KVM]
in any case here is how to convert it:

```
sudo apt-get install qemu-utils
```

```
tar -xvf $image.ova
```

```
qemu-img convert -O qcow2 $image.vdi $image.qcow2
``` 
or 
```
qemu-img convert -O qcow2 $image.vmdk $image.qcow2
```
## Setting up isolated network [host-only] (if you want)

![image](https://user-images.githubusercontent.com/52568048/117667914-b5a2d600-b1a5-11eb-94b5-b37106c36d89.png)

![image](https://user-images.githubusercontent.com/52568048/117668122-e84cce80-b1a5-11eb-8777-96de96c034c9.png)

## Setting up guest machine

### Disable UAC

![image](https://user-images.githubusercontent.com/52568048/117668278-13cfb900-b1a6-11eb-8e80-1991bded3618.png)

### Disable Firewall

![image](https://user-images.githubusercontent.com/52568048/117668323-1d592100-b1a6-11eb-8fa4-c0518ab321cb.png)

### Disable Windows Update

![image](https://user-images.githubusercontent.com/52568048/117668361-277b1f80-b1a6-11eb-8b87-92d049597fd3.png)


## Installing CAPEv2 on host

[cape2.sh](https://raw.githubusercontent.com/doomedraven/Tools/master/Sandbox/cape2.sh)

```
sudo ./cape2.sh base cape | tee cape.log
```

## Downloading CAPE agent on guest [Remember to use a Python x86 installation]

[agent.py](https://raw.githubusercontent.com/kevoreilly/CAPEv2/master/agent/agent.py)

## CAPEv2 [Config](https://capev2.readthedocs.io/en/latest/installation/host/configuration.html) [You can read the other configs to set-up them for your needs]

Go to ```/conf/``` folder, edit ```cuckoo.conf```;
- [resultserver] 
  - ip = YOUR_LOCAL_HOST_IP
 
Edit ```kvm.conf```
  - interface = YOUR_INTERFACE_NAME : virt-manager -> interface -> Connection Details -> Device;
  - label = YOUR_MACHINE_NAME
  - ip = YOUR_GUEST_IP

Make sure host and guest can ping each other.

Go to ```/web/```, -> ```python3 manage.py migrate```, -> ```python3 manage.py runserver 0.0.0.0:8080```

Now you can start to upload your sample, remeber first to create a snapshot of the machine with ```agent.py``` running.

# Attention
This guide has been written with the help of other resources:

- https://notes.netbytesec.com/2020/12/cape-sandbox-installation-from-0-to-hero.html
- https://github.com/kevoreilly/CAPEv2
- https://phoenixnap.com/kb/ubuntu-install-kvm
- https://fazlerabbi37.github.io/blogs/convert_ova_image_to_qcow.html
