# Idea from: https://github.com/AGDCservices/Ghidra-Scripts/blob/master/Preview_Function_Capabilities.py
# If you have some "Key Error" logs, open the "functions_error.txt", you will find a ready copy and paste key:value to add in the dictionary!


import idaapi
import ida_kernwin
import ida_ida
import idc
import idautils
import ida_nalt
import ida_funcs
class myplugin_t(idaapi.plugin_t):
    flags = idaapi.PLUGIN_UNL
    comment = "Automatically renames a function to get a preview of its capabilities"
    help="https://github.com/Finch4/Malware-Analysis-Reports"
    wanted_name = "Functions Capabilities Preview"
    wanted_hotkey = "Alt-F4"

    
    def init(self):
        idaapi.msg("init() called!\n")
        return idaapi.PLUGIN_OK
    


    def run(self, arg):
        apiPurposeDict = {
        'socket':'netwB',

        'WSAStartup':'netwC',
        'connect':'netwC',
        'InternetOpen':'netwC',
        'InternetConnect':'netwC',
        'InternetOpenURL':'netwC',
        'HttpOpenRequest':'netwC',
        'WinHttpConnect':'netwC',
        'WinHttpOpenRequest':'netwC',

        'bind':'netwL',
        'listen':'netwL',
        'accept':'netwL',

        'send':'netwS',
        'sendto':'netwS',
        'InternetWriteFile':'netwS',
        'HttpSendRequest':'netwS',
        'WSASend':'netwS',
        'WSASendTo':'netwS',
        'WinHttpSendRequest':'netwS',
        'WinHttpWriteData':'netwS',

        'recv':'netwR',
        'recvfrom':'netwR',
        'InternetReadFile':'netwR',
        'HttpReceiveHttpRequest':'netwR',
        'WSARecv':'netwR',
        'WSARecvFrom':'netwR',
        'WinHttpReceiveResponse':'netwR',
        'WinHttpReadData':'netwR',
        'URLDownloadToFile':'netwR',

        'inet_addr':'netwM',
        'htons':'netwM',
        'htonl':'netwM',
        'ntohs':'netwM',
        'ntohl':'netwM',


        'RegOpenKey':'regH',

        'RegQueryValue':'regR',
        'RegGetValue':'regR',
        'RegEnumValue':'regR',

        'RegSetValue':'regW',
        'RegSetKeyValue':'regW',

        'RegDeleteValue':'regD',
        'RegDeleteKey':'regD',
        'RegDeleteKeyValue':'regD',

        'RegCreateKey':'regC',

        'CreateFile':'fileH',
        'fopen':'fileH',

        'fscan':'fileR',
        'fgetc':'fileR',
        'fgets':'fileR',
        'fread':'fileR',
        'ReadFile':'fileR',

        'flushfilebuffers':'fileW',
        'fprintf':'fileW',
        'fputc':'fileW',
        'fputs':'fileW',
        'fwrite':'fileW',
        'WriteFile':'fileW',

        'DeleteFile':'fileD',

        'CopyFile':'fileC',

        'MoveFile':'fileM',

        'FindFirstFile':'fileE',
        'FindNextFile':'fileE',

        'strcmp':'strC',
        'strncmp':'strC',
        'stricmp':'strC',
        'wcsicmp':'strC',
        'mbsicmp':'strC',
        'lstrcmp':'strC',
        'lstrcmpi':'strC',

        'OpenService':'servH',

        'QueryServiceStatus':'servR',
        'QueryServiceConfig':'servR',

        'ChangeServiceConfig':'servW',
        'ChangeServiceConfig2':'servW',

        'CreateService':'servC',

        'DeleteService':'servD',

        'StartService':'servS',

        'CreateToolhelp32Snapshot':'procE',
        'Process32First':'procE',
        'Process32Next':'procE',

        'OpenProcess':'procH',

        'CreateProcess':'procC',
        'CreateProcessAsUser':'procC',
        'CreateProcessWithLogon':'procC',
        'CreateProcessWithToken':'procC',
        'ShellExecute':'procC',


        'ReadProcessMemory':'procR',

        'WriteProcessMemory':'procW',

        'CreateThread':'threadC',
        'beginthread':'threadC',

        'OpenThread':'threadO',

        'SuspendThread':'threadS',

        'ResumeThread':'threadR',
        
        'RtlVirtualUnwind':'rtlvirtualunwind',
        'lstrle':'lstrle',
        'FindFirstFil':'findfirstfil',
        'GetLastError':'getlasterror',
        'lstrcp':'lstrcp',
        'lstrcp':'lstrcp',
        'lstrca':'lstrca',
        'lstrcp':'lstrcp',
        'FindNextFil':'findnextfil',
        'FindClose':'findclose',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'lstrcp':'lstrcp',
        'lstrle':'lstrle',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetVolumeInformatio':'getvolumeinformatio',
        'rdi':'rdi',
        'CreateFil':'createfil',
        'CloseHandle':'closehandle',
        'memset':'memset',
        'WNetAddConnection':'wnetaddconnection',
        'wsprint':'wsprint',
        'NetShareEnum':'netshareenum',
        'r13':'r13',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'NetApiBufferFree':'netapibufferfree',
        'WNetOpenEnu':'wnetopenenu',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'WNetEnumResourc':'wnetenumresourc',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'r15':'r15',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'WNetCloseEnum':'wnetcloseenum',
        'OpenServiceA':'openservicea',
        'ControlService':'controlservice',
        'GetTickCount':'gettickcount',
        'Sleep':'sleep',
        'GetTickCount':'gettickcount',
        'CloseServiceHandle':'closeservicehandle',
        'vsnwprintf':'vsnwprintf',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'vsnwprintf':'vsnwprintf',
        'lstrle':'lstrle',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'GetCurrentProcess':'getcurrentprocess',
        'OpenProcessToken':'openprocesstoken',
        'LookupPrivilegeValueA':'lookupprivilegevaluea',
        'AdjustTokenPrivileges':'adjusttokenprivileges',
        'CloseHandle':'closehandle',
        'ReleaseSemaphore':'releasesemaphore',
        'rdi':'rdi',
        'WaitForSingleObject':'waitforsingleobject',
        'CloseHandle':'closehandle',
        'CloseHandle':'closehandle',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetTickCount64':'gettickcount64',
        'Sleep':'sleep',
        'GetTickCount64':'gettickcount64',
        'WaitForSingleObject':'waitforsingleobject',
        'SetEvent':'setevent',
        'CoCreateInstance':'cocreateinstance',
        'wsprint':'wsprint',
        'memset':'memset',
        'lstrle':'lstrle',
        'StrStr':'strstr',
        'lstrle':'lstrle',
        'lstrle':'lstrle',
        'CoSetProxyBlanket':'cosetproxyblanket',
        'SysAllocString':'sysallocstring',
        'SysFreeString':'sysfreestring',
        'StrCmp':'strcmp',
        'StrCmp':'strcmp',
        'StrCmp':'strcmp',
        'StrCmp':'strcmp',
        'StrStr':'strstr',
        'StrStr':'strstr',
        'CreateFil':'createfil',
        'GetLastError':'getlasterror',
        'DeviceIoControl':'deviceiocontrol',
        'CloseHandle':'closehandle',
        'GetLastError':'getlasterror',
        'StrStr':'strstr',
        'lstrcmp':'lstrcmp',
        'lstrcmp':'lstrcmp',
        'StrStr':'strstr',
        'SetFileAttribute':'setfileattribute',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'GetLastError':'getlasterror',
        'GetLastError':'getlasterror',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'WaitForSingleObject':'waitforsingleobject',
        'SetEvent':'setevent',
        'lstrcp':'lstrcp',
        'lstrca':'lstrca',
        'fil':'fil',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'GetLastError':'getlasterror',
        'lstrcp':'lstrcp',
        'lstrcp':'lstrcp',
        'lstrca':'lstrca',
        'CreateFil':'createfil',
        'CloseHandle':'closehandle',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'CloseHandle':'closehandle',
        'TerminateThread':'terminatethread',
        'CloseHandle':'closehandle',
        'CloseHandle':'closehandle',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'CreateEventA':'createeventa',
        'CreateEventA':'createeventa',
        'CreateSemaphoreA':'createsemaphorea',
        'ResetEvent':'resetevent',
        'WaitForSingleObject':'waitforsingleobject',
        'GetLastError':'getlasterror',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'lstrle':'lstrle',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'lstrcp':'lstrcp',
        'CloseHandle':'closehandle',
        'GetLastError':'getlasterror',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetLastError':'getlasterror',
        'EnterCriticalSection':'entercriticalsection',
        'memset':'memset',
        'GetTickCount64':'gettickcount64',
        'LeaveCriticalSection':'leavecriticalsection',
        'Sleep':'sleep',
        'CoInitialize':'coinitialize',
        'CoInitializeSecurity':'coinitializesecurity',
        'IsUserAnAdmin':'isuseranadmin',
        'InitializeCriticalSection':'initializecriticalsection',
        'lstrcp':'lstrcp',
        'lstrca':'lstrca',
        'CreateFil':'createfil',
        'AllocConsole':'allocconsole',
        'GetStdHandle':'getstdhandle',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'CreateEventA':'createeventa',
        'CreateSemaphoreA':'createsemaphorea',
        'CloseHandle':'closehandle',
        'GetLastError':'getlasterror',
        'wfopen':'wfopen',
        'GetLastError':'getlasterror',
        'fgetws':'fgetws',
        'lstrle':'lstrle',
        'feof':'feof',
        'fclose':'fclose',
        'GetLastError':'getlasterror',
        'memcpy':'memcpy',
        'SetFilePointer':'setfilepointer',
        'SetFilePointer':'setfilepointer',
        'SetFilePointer':'setfilepointer',
        'GetLastError':'getlasterror',
        'GetLastError':'getlasterror',
        'GetLastError':'getlasterror',
        'CreateFil':'createfil',
        'GetLastError':'getlasterror',
        'GetFileSize':'getfilesize',
        'GetLastError':'getlasterror',
        'CloseHandle':'closehandle',
        'QueryPerformanceFrequency':'queryperformancefrequency',
        'QueryPerformanceCounter':'queryperformancecounter',
        'TlsGetValue':'tlsgetvalue',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'TlsSetValue':'tlssetvalue',
        'lstrcp':'lstrcp',
        'lstrca':'lstrca',
        'lstrle':'lstrle',
        'SetFileInformationByHandle':'setfileinformationbyhandle',
        'GetLastError':'getlasterror',
        'GetLastError':'getlasterror',
        'fileRfil':'filerfil',
        'SetFilePointer':'setfilepointer',
        'SetEndOfFile':'setendoffile',
        'lstrcp':'lstrcp',
        'lstrle':'lstrle',
        'SetFileInformationByHandle':'setfileinformationbyhandle',
        'QueryPerformanceCounter':'queryperformancecounter',
        'CloseHandle':'closehandle',
        'GetDriveTyp':'getdrivetyp',
        'lstrle':'lstrle',
        'StrStr':'strstr',
        'wsprint':'wsprint',
        'WNetCancelConnection':'wnetcancelconnection',
        'WNetCancelConnection':'wnetcancelconnection',
        'WNetCancelConnection':'wnetcancelconnection',
        'GetLastError':'getlasterror',
        'GetDriveTyp':'getdrivetyp',
        'itProcess':'itprocess',
        'TlsAlloc':'tlsalloc',
        'GetLastError':'getlasterror',
        'SetErrorMode':'seterrormode',
        'Sleep':'sleep',
        'CryptAcquireContex':'cryptacquirecontex',
        'CryptImportKey':'cryptimportkey',
        'CryptEncrypt':'cryptencrypt',
        'CryptDestroyKey':'cryptdestroykey',
        'CryptReleaseContext':'cryptreleasecontext',
        'lstrlenA':'lstrlena',
        'GetComputerNameA':'getcomputernamea',
        'memset':'memset',
        'StrStrIA':'strstria',
        'StrStrIA':'strstria',
        'wsprint':'wsprint',
        'wsprint':'wsprint',
        'lstrle':'lstrle',
        'SHRegSetUSValu':'shregsetusvalu',
        'GetLastError':'getlasterror',
        'lstrcmpiA':'lstrcmpia',
        'TerminateProcess':'terminateprocess',
        'CloseHandle':'closehandle',
        'GetCurrentProcessId':'getcurrentprocessid',
        'GetProcessHeap':'getprocessheap',
        'HeapReAlloc':'heaprealloc',
        'HeapAlloc':'heapalloc',
        'ZwQuerySystemInformation':'zwquerysysteminformation',
        'WideCharToMultiByte':'widechartomultibyte',
        'procH':'proch',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'SetLastError':'setlasterror',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetLastError':'getlasterror',
        'wsprint':'wsprint',
        'StrStrIA':'strstria',
        'StrStrIA':'strstria',
        'StrStrIA':'strstria',
        'StrStrIA':'strstria',
        'StrStrIA':'strstria',
        'StrStrIA':'strstria',
        'servR':'servr',
        'OpenSCManagerA':'openscmanagera',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'CloseServiceHandle':'closeservicehandle',
        'EnumServicesStatusA':'enumservicesstatusa',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'CloseServiceHandle':'closeservicehandle',
        'GetLastError':'getlasterror',
        'wsprint':'wsprint',
        'lstrle':'lstrle',
        'StrCmpN':'strcmpn',
        'lstrle':'lstrle',
        'StrCmpN':'strcmpn',
        'StrCh':'strch',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'CommandLineToArg':'commandlinetoarg',
        'GetModuleFileNam':'getmodulefilenam',
        'StrCmpN':'strcmpn',
        'GetTempPat':'gettemppat',
        'GetTickCount':'gettickcount',
        'wsprint':'wsprint',
        'fil':'fil',
        'memset':'memset',
        'wsprint':'wsprint',
        'CreateProces':'createproces',
        'itProcess':'itprocess',
        'OpenProcessToken':'openprocesstoken',
        'GetTokenInformation':'gettokeninformation',
        'GetLastError':'getlasterror',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'GetTokenInformation':'gettokeninformation',
        'LookupAccountSi':'lookupaccountsi',
        'CloseHandle':'closehandle',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetSystemInfo':'getsysteminfo',
        'GlobalMemoryStatus':'globalmemorystatus',
        'memset':'memset',
        'RtlGetVersion':'rtlgetversion',
        'RtlGetNativeSystemInformation':'rtlgetnativesysteminformation',
        'GetUserNam':'getusernam',
        'GetComputerNam':'getcomputernam',
        'NetGetJoinInformation':'netgetjoininformation',
        'NetApiBufferFree':'netapibufferfree',
        'GetCommandLin':'getcommandlin',
        'StrStr':'strstr',
        'StrStr':'strstr',
        'CopyFil':'copyfil',
        'GetLastError':'getlasterror',
        'GetTickCount':'gettickcount',
        'wsprint':'wsprint',
        'OpenSCManage':'openscmanage',
        'GetLastError':'getlasterror',
        'CreateServic':'createservic',
        'StartServic':'startservic',
        'GetLastError':'getlasterror',
        'CloseServiceHandle':'closeservicehandle',
        'GetLastError':'getlasterror',
        'CloseServiceHandle':'closeservicehandle',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetTickCount':'gettickcount',
        'wsprint':'wsprint',
        'wsprint':'wsprint',
        'wsprint':'wsprint',
        'wsprint':'wsprint',
        'servD':'servd',
        'wsprint':'wsprint',
        'wsprint':'wsprint',
        'servD':'servd',
        'wsprint':'wsprint',
        'DeleteFil':'deletefil',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'wsprint':'wsprint',
        'wsprint':'wsprint',
        'WNetCancelConnection':'wnetcancelconnection',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'lstrcp':'lstrcp',
        'NetGetDCName':'netgetdcname',
        'lstrca':'lstrca',
        'NetApiBufferFree':'netapibufferfree',
        'ADsOpenObject':'adsopenobject',
        'wsprint':'wsprint',
        'wsprint':'wsprint',
        'vsnwprintf':'vsnwprintf',
        'WriteConsol':'writeconsol',
        'GetProcessHeap':'getprocessheap',
        'HeapAlloc':'heapalloc',
        'EnterCriticalSection':'entercriticalsection',
        'vsnwprintf':'vsnwprintf',
        'WriteConsol':'writeconsol',
        'LeaveCriticalSection':'leavecriticalsection',
        'GetProcessHeap':'getprocessheap',
        'HeapFree':'heapfree',
        'DeleteCriticalSection':'deletecriticalsection',
        'CloseHandle':'closehandle',
        'getch':'getch',
        'CloseHandle':'closehandle',
        'EnterCriticalSection':'entercriticalsection',
        'GetTickCount64':'gettickcount64',
        'GetConsoleScreenBufferInfo':'getconsolescreenbufferinfo',
        'SetConsoleCursorPosition':'setconsolecursorposition',
        'LeaveCriticalSection':'leavecriticalsection',

    }
        
        for function in idautils.Functions():
            function_name = idc.get_func_name(function)
            if function_name.startswith("sub"):
                function_start = idc.get_func_attr(function, idc.FUNCATTR_START)
                function_end = idc.get_func_attr(function, idc.FUNCATTR_END)
                function_name_new = ""
                #idaapi.msg(f"{function_name} - {hex(function_start)} - {hex(function_end)}\n")
                for i in range(function_start, function_end):
                    if idc.print_insn_mnem(i) == "call" and not "word" in str(idc.print_operand(i, 0)) and not "sub" in str(idc.print_operand(i, 0)):
                        #idaapi.msg(f"{idc.print_insn_mnem(i)} - {idc.print_operand(i, 0)}\n")
                        try:
                            #idaapi.msg(str(idc.print_operand(i, 0)).replace("Ex","").replace("_","").replace("cs:","").replace("A","").replace("W","")+"\n")
                            key = str(idc.print_operand(i, 0)).replace("Ex","").replace("_","").replace("cs:","")
                            if key[-1] == "W" or key == "A":
                                key = key[0:-2]
                            if apiPurposeDict[key]:
                                function_name_new += "_"+apiPurposeDict[str(idc.print_operand(i, 0)).replace("Ex","").replace("_","").replace("cs:","")]
                        except KeyError:
                            idaapi.msg(f' Key Error for {key}\n')
                            open("functions_error.txt","a").write("'"+key+"'"+":"+"'"+key.lower()+"',")
                idc.set_name(function_start, function_name_new, idc.SN_NOWARN)
                idaapi.msg(f"{function_name} -> {function_name_new}\n")
                

            
        
        

    def term(self):
        idaapi.msg("term() called!\n")
        
def PLUGIN_ENTRY():
    return myplugin_t()
