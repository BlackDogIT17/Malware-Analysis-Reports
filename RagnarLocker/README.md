# RagnarLocker Analysis
**This is my first analysis of a Ransomware**

RagnarLocker seems to use a RSA public key plus an hardcoded key which is then converted in Base64 and wrote in the ransom note.

## Checking OS Language

![image](https://user-images.githubusercontent.com/52568048/118462043-8e488d80-b6fe-11eb-9dc0-2fd446af733d.png)

## Gets Registry Keys

![image](https://user-images.githubusercontent.com/52568048/118462500-057e2180-b6ff-11eb-9656-f202c4bfa144.png)

## Create ID

The retrieved keys are then concatenated and pasased to a function which generates an ID, although this ID isn't used
![image](https://user-images.githubusercontent.com/52568048/118470841-5e51b800-b707-11eb-9844-cf9aecc3fb73.png)
![image](https://user-images.githubusercontent.com/52568048/118470950-7d504a00-b707-11eb-844a-21055ddfb33c.png)

## Config

The config is encrypted with RC4
![image](https://user-images.githubusercontent.com/52568048/118471139-b4bef680-b707-11eb-869a-a2e3f725c64f.png)
![image](https://user-images.githubusercontent.com/52568048/118471226-cef8d480-b707-11eb-87ef-7eb852c25a62.png)

Here is the config decrypted:

Key: 6a4527542f65763d77772f707c6736706f3a3c415d207a6023336b4c6d313c3f4b76427340356e5e734b443a323c427c2b37624b784a7d652a584925275b2a34

- 1: `6aaef2bbb0412df7b821b2c259e01407efeab7932a955d85d396b85ae4394a6797688d10d261eebfbc1808b1f649fb68a416296944f8896517433afb081668af` -> `61bcbDc31F1c894054C3B84aF53C35cF3005e1A69366A6e857a5a4fd60fb7184` [This value is then converted in Base64 and written in the note]
- 2: `71b2bdf5ff470b83c029a3f1349b6c7e99febfe5318044c9b88e81549e456b68ce19f367d03bdee1ee4279bec04fdc11c0640e1d6483ac40704b1dd4766e12d86c70d5f5821f94a56a2270a0f2c6af90e77be4ebfbdb558558e5e3cf48160529c9aaa7cb3746af9cd11cb86c2aa4e5174c98b1eed6ae6fe410e26a354cf414cc86efbdb16867f3685c1f81525f0d36c7ead5c4e18fd36cd9daaa08ce92553dae45893249d50391cad7727425d55c7bf82d8a285c75293e4078c71d2e9a081ad81a78cec8d10eea6a7af74b566463ad750e95e9d28bb9b83232c385911ececd7d5e9c24687a24a7bc986cc358a9404eda6d2db25a9e738b87e435eb9a2d77d3c4e246265a8327d0b357e59fff4f125d4f07f5ce38ef4eea459400dbda78057583833781943babc212b7bdef48311e47e86a04d01c181751bec2e18f9bf6d625abb9b11d5579627f01baf228088e78a3d466b7c87f559df366c40000f87b03fdeb63ee99b6e1c6c95eb94cea45dacf3578bff50e369698b3c71f0fcc740cfde075583821bffcd227f8337037e245aa17575a0c99b06460380d8316c4105c12460386d385c18d3417b51f5b81ade3cbbece8422377ea5e919f4bd03b9e16354c3cb1f3210` ->
<pre> 
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmsJpwCxEV7oGmDQQIv2e
tBcswVgSnljxMxS2NTpjFWePLaiq+NJvgmYExQHz69RG9Qo4cZ48PaHr2W4KdOYs
jad4m2JjcUtlgDgE8RnFLK6WnMusg7dh/dmPxtUD48CBR2GrFUG/e9dQDQWkccLA
0dsDCB3pirDh1HIoDvPn+5kYR/0WteOUirLUK8pdem3dnZamlj4fSAThBjrwk4qy
7HGX8D350O92H3MXWsOkPzlPRjgXPm/mGV5F8xa4emZcYiyGKUeZvMAgEa5suHEN
m6dGtjWtuHXiidJYjTVEsvOkLufWczK+b90GUmPq6/9ZaPDoqzjIl64mE7kdqFEL
qQIDAQAB
-----END PUBLIC KEY-----
</pre>
- 3: `2aece3f4a17422e8e402eed500aa0c5abfae9bc31b811a8be5cbe46afb7a4c44c5359147d633c4fcf5074ef2db0cfb27f05864304aab82640d1f33fe524239f52758f9dabd3fb6bc6e0173b29dcd9aaab167cbf2d0fa` -> `vss,sql,memtas,mepocs,sophos,veeam,backup,pulseway,logme,logmein,connectwise,splashtop`
- 4: `2feefcf4bd772fa7e502afce02aa5353f6ba96d306c019c8e6dae57aa36544448839da4bc323d9eaa9424df6db0ff225e2523e3f09b4897252053ffa50497cf6725ff3c7b82ebab86a0d72a1d8dd8feabf77c2f3cbe571bc4aa4aaa05237152cddd0a6f12b4fa38be4489f3c0d82f11e65a1b2d7fde36bec5fc953285ff63df891cdd9a43d31cc42492a8c03523037cf96c7fdf1deeb2af7cd8023cbf15c39e6149c6366d34cadd0dd7a4023e40c05fb18a700094734001966d35a3f900b11db2f6ed5e9f016bd5c4cc9167e7d09885d5695a2c6b489c5162dc587b073b0957c4fb913063d3cbba0b8618072895d6e804b2aea069a06aec1ba15f08d060ecdd9dc771d03976ff0ba11cd98cb454d626c7ec0b11bde48cf4688129c8c6c121ac0a503f5ce1aeb92508ee1af2c722573cc6f39972e07096481c7f2b2e7cd8104838cef3f02766d1801a5de2e23` -> `sql,oracle,ocssd,dbsnmp,synctime,agntsvc,isqlplussvc,xfssvccon,mydesktopservice,ocautoupds,encsvc,firefox,tbirdconfig,mydesktopqos,ocomm,dbeng50,sqbcoreservice,excel,infopath,msaccess,mspub,onenote,outlook,powerpnt,steam,thebat,thunderbird,visio,winword,wordpad,EduLink2SIMS,bengine,benetns,beserver,pvlsvr,beremote,VxLockdownServer`
- 5: `76b5baf2f82f64eea34da98b4bf30a1df0f4de8a428743cebf89a133fd26030b8e72970f9d7a85a3af0114ad9d55b47abb0b62760fe6c52b0b5976b3150d7ab12111bc9ef970ffe233422afd9b94c0ecfa3e89ac95a02ee604fdacef167e4c7094d6eab27300efceb64ec1744edabf5720c2de9ebaef26b51b8c00630bb96da9de9ed5eb7e7e810f456ece461c7722df9a94acb39da478b29ec5719db81f7cea51c420239f2881f2f75a1015d52365d7399c2025034a791542c60a339d525ec72f61def4fb5df25d50cc0a317b408b414097b59afa89810037809fb22ab6dd7748ac10453b3feeb9bd77d240a5614ff86f02cd2ab10ab8c6b042fe930e02d5d08e6a02178163d3b708e482854f11550557f2e9189b4ec95cc615d58b675c3afa882280fc2bddb32ff2a4fd2022733f9f396b9b6c425b21cc88a6f7ebbbd968cccfa47b4d2123466ef7886b71c721c4bf13f2b22938fcb403851553ad136693c12ef8ddd1b58cbe0aec24920c938b5f01f5817853c5ce9ed57328eb6421c6f901764e52b3eced57a8085503b20ed07912015cd9d3227c264aec0b855e077e2965a688fea2e35f6cde777b86aae4ccb9a1e04c3d04da817f97d409d88e1053c4cc18353093eaada4d61d07fdd761b3516f822167adc294db773f5cb109e1c917f2c4874d64e03a0271247a7123233516fe9935ad8338601a9a82381d4b795e5e43bf0f2ffc14791b85e1cba6fe6aec5068fb27001aa42f244a4a6ac87cb228c31f0b49e97e3c68da6e43e4c4fde62ccf16fdbdc78960cd93f3d7d6c4765cadc07937f670f7324d1e8a59b8c981588eb860b85415e8b889121a98832a4f3e790aa2e406e5b7b1c973b66c71cc33e78007de7b75f906e25d125a002a5c9b00864b4c5105bc014f915d283df05b12cbd44e25d9ca2dbae5ac7a12b01e33af5670d8223e2010010d580581725d5c0108479d042317032bd51984151f78da47719471334d39fa6b2f37999e61d55f085265d848ba1a04615a505d0522432fb809aae3eedc6875dbb9a82c2e2a93b08be311ab68b90cf6b116f1f32a63b0e17c4dff90d6cf5395de4b6f9ddbc0407f834d913a6bbd363859e2e05995c05cb1fbcf9058b7d4d7b62469efe0c8d95bf7b4f455f2f29756d43fb6f7450ba4eb58c201194b1bfe355290d6ac266c3b6ef1b5461556bb43c3b50b02956ddd64ca17ec26631205aa25e6936f660a7e1660ca29ba26b7a678359c22f1a2c41861750bcf8e6f0d198449e9753bf814090f1e516994d73368bdd07eff4fb32cee55165294bbfed3befdb4a227ae038e2080c251970a9b4a1f6dd1d4b93b3b4daf8d8daa5a5c77912afb69524381848e2056dee55463a85dc83be714e0112b307772af259e4931d998a9dcd0dabd368b5a5e479c54cf66ee43cca622329fbfa29aa454a7e61af4babf1f6bc3a3679fa6071dabbd3d1e2865103d00f1bfa83aca27308d912a296050d7616cd2a32e9ff1065f6cc3cb0170b830b25839b7a9da0d6135ebfe22ce3e2a74702cbf6d8072d5a61429174f8dc32eefdd2f37bd4d96975762d7fda5de8c5e614b019ca2e2dfcf3abebff0f4a15b4a6d54019687480161d919fa05955e839c973399653dff910909494b8fbce57a6a0621334af558b6aba220621eae205bfae70868a1c98622e89585502e2d9a1c26eefe8f875bc472be961fda657e70f64a6b1b47846e444188659f1c39854700040076fd5b2dc0d4afd560f3255e5e51d3d553afa732a09021d9c3b1ef457b8eeab0b9807b3acf269180d0ea334d929c8f440a2c245f24f12487789f89ec1dcde6b7c9bf6e229f8df6b61d9a4834d4fdab19ec17fe03c2b5f88eef584779006012faf355144885517795196d2372a58309b7ebff44b395c9a2b6d51cc89182964cfdd50133dd5491411f7b6d000d25de61022b61f43d00816ac6ad8fb9f8fc43fcf87c74e33f812ab13b4c907f34bb2f5546c7d0b0da675078f4600288e5ed7ddace338836669f656b9616b0887f81b6dc59365280da9d6657b69ebbc9686d979c9c6beb6f665236e6200f31d17df8fe2fefcd7667eb59e7b1d0618cc34d510b1e3d5b3724245f9555d720ebfeef89319b79a22aa1a753b947945e836a6c15524e389bd8ac3ccc55ad39a6e7dee35016c8f564e5d4fc71cc19730ac877093b540226fbffa0a76e1e518e936e723dca3c5bd9da299ea04c9747182472793f437c132335808da9353d2b3fa2f728bae54e0b017d76d41f2410bf2a18f330e8172059f01fca446dc16c9c2e2c9e38515e4be282eeb7bfa332c459358fe7ea567441ed812ce6f2f1fe4869e683f97bdf85936b6950e9c4393fa24d9ec9668a7a94244a8517282af7f19526e7fc42cba314eb03d53fc2d3bbc462b1b10f842a2f448b42071d9cc091bf7bec583a1954adcaff0bf843e83726c10cd97c4ca5812ddc4c471d617d482075f02a6ffd39f530d4363b0855e37b33f3d9349198d2fe8d490c472e48606434c01dd610dcc7d80d575e4b21472d38618e88270034d22d72b3d86bd9379bb3013bcaa8f6f5e51b4e4fa72b90c6d5a3dd66f124dfe6888c519853f0c1d5ef273b803e92b25e195481e42d87e53d15a33e74d3b98137b5ba6ef51cb036cb762e7786d4bd1de50dcf76463c0c7f529c5361a97514dfef720d602124e65256e136959851448c1780b8d61591a36f9418e58f27991d10eb05ddda2a425971e7b9e3b635d1102d8779ba` ->
<pre>
*****************************************************************************************************************
                                                  HELLO WEGLARZCO!
 If you reading this message, then your network was PENETRATED and all of your files and data has been ENCRYPTED
                             
                                              by RAGNAR_LOCKER !

*****************************************************************************************************************

                                              !!!!! WARNING !!!!!

DO NOT Modify, rename, copy or move any files or you can DAMAGE them and decryption will be impossible.
DO NOT use any third party or public decryption software, it also may damage files.
DO NOT Reinstall your OS
DO NOT Delete readme files
-------------------------------------

There is ONLY ONE possible way to get back your files - contact us and pay for our special DECRYPTION key !
For your GUARANTEE we will decrypt 2 of your files FOR FREE, as a proof of our capabilities.

Don't waste your TIME, the link for contacting us will be deleted in closest future if there is no contact made and you will never restore your DATA.
HOWEVER if you will contact us within 2 day since get penetrated - you can get a very SPECIAL PRICE.


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! HERE IS THE SIMPLE MANUAL HOW TO GET CONTCAT WITH US !
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
Ð°) Download and install TOR browser from this site : https://torproject.org
b) Open our website  : hxxp://mykgoj7uvqtgl367.onion/client/?61bcbDc31F1c894054C3B84aF53C35cF3005e1A69366A6e857a5a4fd60fb7184
c) If Tor is restricted in your area, use VPN

Follow the instructions on the website.
At the top you will find CHAT tab. 
Send your message there and wait for response (we are not online 24/7, So you have to wait for your turn).
</pre>
## Enum services and processes and check if contains the values from the list of strings decrypted before [sql,oracle,ocssd,dbsnmp, etc....]
![image](https://user-images.githubusercontent.com/52568048/118472391-12077780-b709-11eb-9842-2114314efbdf.png)
![image](https://user-images.githubusercontent.com/52568048/118472474-2b102880-b709-11eb-91d4-3c2d1bac878c.png)
![image](https://user-images.githubusercontent.com/52568048/118472538-3c593500-b709-11eb-8a10-7a82bcaf9633.png)

## Calculates another ID with the value of GetComputerNameW and create a .txt in the Documents Folder

![image](https://user-images.githubusercontent.com/52568048/118472832-9659fa80-b709-11eb-8772-1f60158832d3.png)

![image](https://user-images.githubusercontent.com/52568048/118472883-a671da00-b709-11eb-877f-567ac8f47198.png)

I wrote the algorithm for the ID generation in Python and also a config extractor [This is my first time writing a config extractor isn't fully working], you can find it here: https://github.com/Finch4/Malware-Analysis-Reports/blob/main/RagnarLocker/ragnar_locker_config_extractor.py

## The first decrypted key is then converted to Base64 and written in the ransom note

![image](https://user-images.githubusercontent.com/52568048/118473362-2a2bc680-b70a-11eb-90de-7de5d935dd07.png)
![image](https://user-images.githubusercontent.com/52568048/118473573-6bbc7180-b70a-11eb-9348-0c0cbb0c1342.png)

## Encryption

Seen this is my first analysis of a Ransomware I didn't fully understand the encryption, but seen the presence of AES and RSA [In the crypto functions] and a key (which is not the public one) written in the config
I presume is the classic AES+RSA

The Ransomware checks for file to avoid during the encryption; if is executed with the command `-force` seems ignoring checking the DriveType

`-force`

![image](https://user-images.githubusercontent.com/52568048/118474027-e9807d00-b70a-11eb-95ea-ba9973ef38c1.png)
![image](https://user-images.githubusercontent.com/52568048/118474075-f7360280-b70a-11eb-98e8-f5e2e8b5ead4.png)

Normal:

![image](https://user-images.githubusercontent.com/52568048/118474365-467c3300-b70b-11eb-880b-e757aa6f0c80.png)
![image](https://user-images.githubusercontent.com/52568048/118474407-509e3180-b70b-11eb-817d-c147f102f157.png)

This is a list of what seems to be avoided: 
`"Windows", "Windows.old", "Tor browser" ,"Internet Explorer" ,"Google" ,"Opera" ,"Opera Software" ,"Mozilla" ,"Mozilla Firefox" ,"$Recycle.Bin" ,"ProgramData" ,"All Users"`

`"autorun.inf", "boot.ini" ,"bootfont.bin" ,"bootsect.bak" ,"bootmgr" ,"bootmgr.efi" ,"bootmgfw.efi" ,"desktop.ini" ,"iconcache.db" ,"ntldr" ,"ntuser.dat" ,"ntuser.dat.log" ,"ntuser.ini" ,"thumbs.db"`

`".db"; ,".sys"; ,".dll"; ,".lnk"; ,".msi"; ,".drv"; ,".exe";`

## At the end `notepad.exe` is executed passing the Ransom note as argument

![image](https://user-images.githubusercontent.com/52568048/118474514-71ff1d80-b70b-11eb-8e0d-4beddf790431.png)
